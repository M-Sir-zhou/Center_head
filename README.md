# 圆柱体智能检测系统

一个集成了中心点检测、首尾判断、条纹颜色识别的智能圆柱体检测系统。

## 📋 功能概览

### 1. 中心点检测（smart_detector.py）
- 🧠 **智能视角识别** - 自动判断端面视图或侧面视图
- 🔵 **端面检测** - 使用霍夫圆变换检测圆形截面
- 🟢 **侧面检测** - 使用轮廓分析检测长条形圆柱体
- 🎨 **条纹颜色识别** - 自动识别侧面长条形的彩色条纹（黄、蓝、红、绿）

### 2. 首尾判断（head_tail_detector.py）
- 🎯 **圆环条纹检测** - 分析端面圆环区域的条纹颜色
- ✅ **智能判断** - 有彩色/黑色条纹 = HEAD，无条纹 = TAIL
- 📊 **置信度评估** - 提供判断置信度

### 3. 批量处理（batch_process.py）
- 📁 **目录扫描** - 自动处理整个文件夹
- 📊 **CSV报告** - 生成详细的检测数据报告
- 🖼️ **可视化输出** - 保存标注后的图像

## 🚀 快速开始

### 安装依赖
```bash
pip install opencv-python numpy
```

### 1. 中心点检测 + 颜色识别

```bash
# 单张图像
python smart_detector.py "data/input/p(1).jpg"

# 批量处理
python batch_process.py
# 结果保存至: data/output/center/
```

**输出信息：**
- 视图类型（端面/侧面）
- 中心坐标、尺寸参数
- 条纹颜色（仅侧面长条形）

### 2. 首尾判断

```bash
# 单张图像
python head_tail_detector.py "data/input_is_head/1/h(1).jpg"

# 批量处理
python head_tail_detector.py --batch
# 输入: data/input_is_head/
# 输出: data/output/head/
```

**判断标准：**
- 端面圆环有**彩色条纹**(>5%)或**黑色条纹**(>10%) → **HEAD**
- 端面圆环无条纹 → **TAIL**

## 📂 目录结构

```
Center_head/
├── data/
│   ├── input/              # 中心检测输入
│   ├── input_is_head/      # 首尾判断输入
│   └── output/
│       ├── center/         # 中心检测结果
│       └── head/           # 首尾判断结果
├── smart_detector.py       # 中心检测
├── head_tail_detector.py   # 首尾判断
├── batch_process.py        # 批量处理
└── README.md
```

## 🔬 技术详解

### 1. 中心点检测

#### 智能视角识别
自动判断圆形(端面)或矩形(侧面)，选择最佳检测方法：

**决策因素：**
- 圆形半径范围（40px < r < 图像×0.2）
- 轮廓宽高比
- 面积占比
- 形状规则性

#### 端面检测
- **方法：** 霍夫圆变换 `cv2.HoughCircles`
- **输出：** 圆心坐标、半径
- **颜色：** 不检测（跳过）

#### 侧面检测
- **方法：** 轮廓分析（多策略二值化 + Canny边缘）
- **输出：** 质心坐标、边界框、方向
- **颜色：** 
  - 条件：长条形（宽高比 >= 1.3）
  - HSV分析：黄/蓝/红/绿（占比>8%）
  - 跳过：端面、接近正方形（宽高比<1.3）

### 2. 首尾判断

#### 圆环区域提取
```python
outer_radius = radius * 1.02  # 外圆
inner_radius = radius * 0.85  # 内圆（排除空洞）
```

#### 条纹颜色检测（HSV）

**彩色条纹（阈值 > 5%）：**
- `yellow`: H=[20,35], S>80, V>80
- `blue`: H=[100,130], S>80, V>80
- `red`: H=[0,10]∪[170,180], S>80, V>80
- `green`: H=[40,80], S>80, V>80

**黑色条纹（阈值 > 10%）：**
- `black`: S<100, V<50

#### 判断逻辑
```python
if 检测到彩色条纹 or 黑色条纹:
    return HEAD（置信度90%）
else:
    return TAIL（置信度90%）
```

### 3. 核心技术要点

#### 多参数策略
使用多组参数组合，提高检测鲁棒性：
```python
param_sets = [
    (50, 100, 30, 20, 500),  # 标准
    (40, 80, 25, 30, 400),   # 宽松
    (60, 120, 35, 40, 600),  # 严格
]
```

#### 轮廓评分系统
综合多个特征加权评分：
```python
score = (area^0.6) * rectangularity * area_score * shape_score
```
- 面积开方：降低大轮廓优势
- 分段评分：不同范围给予不同权重
- 多因子融合：避免单一指标误判

#### 中文路径支持
```python
# OpenCV不支持中文路径，使用numpy读写
image = cv2.imdecode(np.fromfile(path, dtype=np.uint8), cv2.IMREAD_COLOR)
cv2.imencode('.jpg', image)[1].tofile(output_path)
```

## 📊 输出示例

### 中心检测结果（CSV）
```csv
文件名,视图类型,中心X,中心Y,半径,宽度,高度,方向,条纹颜色
p(1).jpg,端面视图,671,838,189,,,端面,
p(2).jpg,侧面视图,546,920,,410,1276,vertical,yellow
p(3).jpg,侧面视图,970,751,,1378,473,horizontal,
```

### 首尾判断结果（CSV）
```csv
文件名,类型,条纹得分,置信度,圆环颜色
h(1).jpg,TAIL,0.0,90.00%,
h(2).jpg,HEAD,100.0,90.00%,yellow
```

## 🎨 可视化标注

### 中心检测
- **圆形：** 绿色圆圈、红色圆心、蓝色十字线、黄色直径线
- **矩形：** 绿色轮廓、紫色边界框、红色中心点、蓝色十字线
- **文字：** 视图类型、坐标、尺寸、颜色

### 首尾判断
- **HEAD：** 右上角红色标签
- **TAIL：** 右上角绿色标签
- **底部：** 类型、得分、置信度

## 💡 使用建议

1. **图像质量**：清晰、光照均匀、背景简单
2. **拍摄角度**：
   - 端面视图：正对圆形截面
   - 侧面视图：平行于圆柱体轴线
3. **首尾判断**：确保端面圆形完整可见，条纹清晰
4. **批量处理**：建议先单张测试，确认效果后再批量

## 🔧 依赖版本

- Python 3.7+
- OpenCV 4.5+
- NumPy 1.19+

---

**问题反馈：** 如遇检测错误，请检查图像质量、拍摄角度，或调整代码中的阈值参数。
